<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Control Space</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #eceff1;
            font-family: system-ui, Arial, sans-serif;
            color: #222;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 220px;
            background: #fff;
            color: #263238;
            padding: 36px 0 0 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-right: 1px solid #e3e7ed;
            box-shadow: 2px 0 8px 0 rgba(60,72,88,0.03);
        }
        .sidebar h2 {
            color: #1976d2;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }
        .sidebar button {
            width: 90%;
            background: none;
            border: none;
            color: #1976d2;
            padding: 15px 30px;
            text-align: left;
            font-size: 1em;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: background 0.18s, color 0.18s;
            box-sizing: border-box;
            display: block;
        }
        .sidebar button:hover {
            background: #e3f2fd;
            color: #1565c0;
        }
        .page-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-left: 32px;
            padding-right: 0;
        }
        @media (max-width: 700px) {
            .page-wrap { padding-left: 8px; }
            .sidebar { width: 100px; padding: 18px 0 0 0; }
        }
        #breadcrumb {
            font-size: 0.85em;
            color: #607d8b;
            margin: 32px 0 18px 0;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-weight: 500;
        }
        #breadcrumb a {
            color: #1976d2;
            text-decoration: none;
            margin: 0 2px;
        }
        #breadcrumb a:hover {
            text-decoration: underline;
        }
        #breadcrumb span {
            color: #90a4ae;
        }
        h1, h2 {
            font-weight: 600;
            margin: 0 0 24px 0;
            font-size: 1.35em;
            letter-spacing: 0.01em;
        }
        #main-content, #table-container {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 24px 0 rgba(60,72,88,0.07);
            padding: 32px 18px 24px 18px;
            margin-top: 8px;
            max-width: 950px;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            background: transparent;
        }
        th, td {
            padding: 16px 14px;
            border: none;
            font-size: 1.04em;
        }
        th {
            background: #f5f7fa;
            font-weight: 700;
            color: #263238;
            border-bottom: 2px solid #e3e7ed;
            letter-spacing: 0.04em;
        }
        td {
            background: none;
            border-bottom: 1px solid #f0f1f3;
            transition: background 0.2s;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:hover td {
            background: #f3f6fa;
        }
        td[contenteditable="true"] {
            background: #f7fafc;
            border-radius: 8px;
            outline: none;
            transition: background 0.2s;
        }
        td[contenteditable="true"]:focus {
            background: #e3f2fd;
        }
        button, .button {
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 8px 22px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s;
            margin: 0 2px;
            font-weight: 500;
            box-shadow: 0 1px 4px 0 rgba(25,118,210,0.07);
        }
        button:hover, .button:hover {
            background: #1565c0;
        }
        button:disabled, .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #add-row {
            margin-bottom: 18px;
            background: #fff;
            color: #1976d2;
            border: 1px solid #1976d2;
            box-shadow: none;
        }
        #add-row:hover {
            background: #e3f2fd;
            color: #1565c0;
        }
        button.delete-row {
            background: #ffeaea;
            color: #d32f2f;
            border: none;
            border-radius: 999px;
            padding: 8px 22px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s;
            margin: 0 2px;
            font-weight: 500;
            box-shadow: 0 1px 4px 0 rgba(211,47,47,0.07);
        }
        button.delete-row:hover {
            background: #ffd6d6;
            color: #b71c1c;
        }
        .sidebar button.db-select-btn {
            background: #f5f7fa;
            color: #1976d2;
            font-weight: 700;
            border: 1.5px solid #1976d2;
            margin-bottom: 18px;
        }
        .sidebar button.db-select-btn:hover {
            background: #e3f2fd;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Control Space</h2>
            <button id="pick-db" class="db-select-btn">Database Selection</button>
            <button id="view-areaslevel3">View Areaslevel3 Table</button>
            <button id="view-room-schedule-all">Room_Schedule Table</button>
            <button id="view-item-descriptions-search">Search Item Descriptions</button>
            <button id="view-room-types-search">Search Room Types</button>
        </div>
        <div class="page-wrap">
            <nav id="breadcrumb"></nav>
            <div class="main" id="main-content">
                <h1 id="welcome-title">Welcome</h1>
                <p id="welcome-desc">Select an option from the sidebar.</p>
            </div>
        </div>
    </div>
    <script>
        // Extract db name from URL
        const dbName = decodeURIComponent(window.location.pathname.split('/').pop());
        function renderBreadcrumb() {
            const homeUrl = `/db/${encodeURIComponent(dbName)}`;
            const html = `<a href="${homeUrl}">Home</a> &gt; <span>Areaslevel3</span>`;
            document.getElementById('breadcrumb').innerHTML = html;
        }
        renderBreadcrumb();
        // Show db name in welcome box
        document.getElementById('welcome-title').textContent = 'Welcome';
        document.getElementById('welcome-desc').textContent = `You are viewing: ${dbName}`;
        document.getElementById('view-areaslevel3').onclick = function() {
            loadAreaslevel3Table();
        };
        document.getElementById('pick-db').onclick = function() {
            window.location.href = '/';
        };
        document.getElementById('view-room-schedule-all').onclick = function() {
            const parts = window.location.pathname.split('/');
            const db = decodeURIComponent(parts[2]);
            window.location.href = `/db/${encodeURIComponent(db)}/room_schedule_all`;
        };
        document.getElementById('view-item-descriptions-search').onclick = function() {
            const parts = window.location.pathname.split('/');
            const db = decodeURIComponent(parts[2]);
            window.location.href = `/db/${encodeURIComponent(db)}/item_descriptions_search`;
        };
        document.getElementById('view-room-types-search').onclick = function() {
            const dbName = decodeURIComponent(window.location.pathname.split('/').pop());
            window.location.href = `/db/${encodeURIComponent(dbName)}/room_types_search`;
        };
        async function loadAreaslevel3Table() {
            const res = await fetch(`/api/db/${encodeURIComponent(dbName)}/areaslevel3`);
            if (!res.ok) {
                document.getElementById('main-content').innerHTML = `<p style='color:red;'>Failed to load table: ${await res.text()}</p>`;
                return;
            }
            const data = await res.json();
            if (!data.rows || data.rows.length === 0) {
                document.getElementById('main-content').innerHTML = '<p>No data found in Areaslevel3.</p>';
                return;
            }
            renderAreaslevel3Table(data);
        }
        function renderAreaslevel3Table(data) {
            let html = '<h1>Areaslevel3 Table</h1>';
            html += '<button id="add-row">Add Row</button>';
            html += '<table><thead><tr>';
            data.columns.forEach(col => { html += `<th>${col}</th>`; });
            html += '<th>Action</th></tr></thead><tbody>';
            data.rows.forEach(row => {
                html += '<tr>';
                row.forEach((cell, colIdx) => {
                    const colName = data.columns[colIdx];
                    if (colName === 'ParentArea') {
                        html += `<td contenteditable="true" data-col="${colName}">${cell}</td>`;
                    } else if (colName === 'Area') {
                        html += `<td data-col="${colName}" style="background:#eee;">${cell}</td>`;
                    } else {
                        html += `<td contenteditable="true" data-parentarea="${row[0]}" data-col="${colName}" onblur="window.saveCell(this)">${cell}</td>`;
                    }
                });
                // Add AL2 button using ArealevelID (assume column name is 'ArealevelID')
                const arealevelIDIdx = data.columns.indexOf('ArealevelID');
                const arealevelID = arealevelIDIdx !== -1 ? row[arealevelIDIdx] : '';
                html += `<td><button class="al2-btn" data-arealevelid="${arealevelID}">AL2</button> <button class="delete-row" data-parentarea="${row[0]}">Delete</button></td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            document.getElementById('main-content').innerHTML = html;

            // Add row handler
            document.getElementById('add-row').onclick = function() {
                const table = document.querySelector('#main-content table tbody');
                let newRow = '<tr>';
                data.columns.forEach((col, idx) => {
                    if (col === 'ParentArea') {
                        newRow += `<td contenteditable="true" data-col="${col}"></td>`;
                    } else if (col === 'Area') {
                        newRow += `<td data-col="${col}" style="background:#eee;"></td>`;
                    } else {
                        newRow += `<td contenteditable="true" data-col="${col}"></td>`;
                    }
                });
                newRow += `<td><button class="save-new-row" disabled>Save</button><span class="area-warning" style="color:red;display:none;margin-left:10px;"></span></td></tr>`;
                table.insertAdjacentHTML('afterbegin', newRow);
                // Save handler
                table.querySelector('.save-new-row').onclick = async function() {
                    const tds = this.closest('tr').querySelectorAll('td');
                    const rowData = {};
                    tds.forEach(td => {
                        const col = td.getAttribute('data-col');
                        if (col && col !== 'Area') rowData[col] = td.textContent;
                    });
                    const dbName = decodeURIComponent(window.location.pathname.split('/').pop());
                    const res = await fetch(`/api/db/${encodeURIComponent(dbName)}/areaslevel3/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(rowData)
                    });
                    if (!res.ok) {
                        alert('Failed to add row: ' + await res.text());
                    } else {
                        loadAreaslevel3Table();
                    }
                };
                // Enable save only if ParentArea is filled
                const parentAreaTd = table.querySelector('td[data-col="ParentArea"]');
                const saveBtn = table.querySelector('.save-new-row');
                parentAreaTd.oninput = function() {
                    saveBtn.disabled = parentAreaTd.textContent.trim() === '';
                };
                saveBtn.disabled = true;
            };
            // Delete row handler
            document.querySelectorAll('.delete-row').forEach(btn => {
                btn.onclick = async function() {
                    if (!confirm('Delete this row?')) return;
                    const parentArea = this.getAttribute('data-parentarea');
                    const dbName = decodeURIComponent(window.location.pathname.split('/').pop());
                    const res = await fetch(`/api/db/${encodeURIComponent(dbName)}/areaslevel3/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ parent_area: parentArea })
                    });
                    if (!res.ok) {
                        alert('Failed to delete row: ' + await res.text());
                    } else {
                        loadAreaslevel3Table();
                    }
                };
            });
            // AL2 button handler
            document.querySelectorAll('.al2-btn').forEach(btn => {
                btn.onclick = function() {
                    const dbName = decodeURIComponent(window.location.pathname.split('/').pop());
                    const arealevelID = this.getAttribute('data-arealevelid');
                    window.location.href = `/db/${encodeURIComponent(dbName)}/areaslevel2/${encodeURIComponent(arealevelID)}`;
                };
            });
        }
        
        // Auto-load Areaslevel3 if ?show=areaslevel3 is present in the URL
        if (window.location.search.includes('show=areaslevel3')) {
            loadAreaslevel3Table();
        }

        window.saveCell = async function(td) {
            const dbName = decodeURIComponent(window.location.pathname.split('/').pop());
            const parentArea = td.getAttribute('data-parentarea');
            const column = td.getAttribute('data-col');
            const newValue = td.textContent;
            if (!parentArea || !column) return;
            const res = await fetch(`/api/db/${encodeURIComponent(dbName)}/areaslevel3/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ parent_area: parentArea, column, value: newValue })
            });
            if (!res.ok) {
                td.style.background = '#fbb';
                setTimeout(() => td.style.background = '', 1000);
                alert('Failed to save change: ' + await res.text());
            } else {
                td.style.background = '#bfb';
                setTimeout(() => td.style.background = '', 500);
            }
        }
        window.validateAreaCell = undefined;
    </script>
</body>
</html> 